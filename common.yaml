---

# Common steps

version: 2alpha

vars:
  super_linter_mount: "./"
  super_linter_tag: "latest"
  super_linter_enable: false

steps:

  +clean:

  +prebuild:

  +build:
    depends_on:
      - +prebuild

  +test:

  +lint:

  # Generate a default version for the build, if nothing else
  # generates one
  default_version:
    depends_on:
      - +prebuild
    required_by:
      - +build
    when:
      - "version|default('') == ''"
    block:
      steps:
        - name: Extract git sha from repo
          bash:
            cmd: git log -1 --format=%h
            capture: git_sha
            capture_strip: true

        - name: Parse default version source
          semver:
            required: true
            sources:
              - "0.1.0-rolling+{{ git_sha }}"
            store: version

  super_linter:
    name: Run github super linter
    during:
      - +lint
    command:
      cmd: >-
        docker run --rm
        -e RUN_LOCAL=true
        -e DEFAULT_BRANCH=main
        -e IGNORE_GITIGNORED_FILES=true
        -v "{{ super_linter_mount }}":/tmp/lint
        ghcr.io/super-linter/super-linter:"{{ super_linter_tag }}"
    when:
      - "super_linter_enable"

actions:

  super_linter:
    vars:
      super_linter_enable: true
    steps:
      - super_linter

